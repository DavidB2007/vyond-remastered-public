function showImporter(){if(!show_importer){show_importer=true;adjust_studio();var a=$(".ga-importer");if(!a.data("importer")){var b=false;if($("#studio_holder").length){b=studioApi($("#studio_holder"))}if(!!(window.ProgressEvent&&window.FormData)){a.data("importer",new Importer(a,b))}else{a.data("importer",new ImporterDegrade(a,b))}}a.data("importer").show()}else{hideImporter()}}function hideImporter(){show_importer=false;$(".ga-importer").data("importer").hide();adjust_studio()}var Importer=function(a,b){this.$el=a;this.$list=this.$el.find(".ga-importer-files");this.$queue=this.$el.find(".ga-importer-queue");this.importedCount=0;this.studio=b;this.initialize()};Importer.prototype.initialize=function(){var a=this;this.$el.find(".ga-importer-results").hide();$(document).on("dragover",function(c){c.dataTransfer=c.originalEvent&&c.originalEvent.dataTransfer;var b=c.dataTransfer;c.preventDefault();c.stopPropagation();b.dropEffect="none"});this.$el.on("dragenter",function(b){b.preventDefault();b.stopPropagation();a.$el.find(".ga-import-dnd-hint").addClass("dragover")}).on("dragover",function(c){c.dataTransfer=c.originalEvent&&c.originalEvent.dataTransfer;var b=c.dataTransfer;c.preventDefault();c.stopPropagation();b.dropEffect="copy"}).on("dragleave",function(b){b.preventDefault();b.stopPropagation();if($(b.target).hasClass("ga-import-dnd-hint")){a.$el.find(".ga-import-dnd-hint").removeClass("dragover")}}).on("drop",function(b){b.dataTransfer=b.originalEvent&&b.originalEvent.dataTransfer;b.preventDefault();a.addFiles(b.dataTransfer.files);a.$el.find(".ga-import-dnd-hint").removeClass("dragover")}).on("videoReady",function(){a.updateResults()}).on("uploadReady uploadCanceled",function(){a.checkList()});this.$el.find(".ga-importer-file-input").on("change",function(){a.addFiles(this.files)});this.$el.find(".ga-importer-notice-clear").click(function(b){b.preventDefault();a.clearList()});this.$el.find("i.i-help").hover(function(){$(this).next(".tooltip").fadeIn()},function(){$(this).next(".tooltip").fadeOut()});if(this.studio){this.studio.bind("userAssetReady",$.proxy(this.onAssetReady,this)).bind("userAssetDelete",$.proxy(this.onAssetDelete,this))}};Importer.prototype.show=function(){this.$el.addClass("show")};Importer.prototype.hide=function(){this.$el.removeClass("show")};Importer.prototype.clearList=function(){this.$list.find(".imported, .canceled, .invalid").remove();this.updateResults()};Importer.prototype.updateResults=function(){this.importedCount=this.$list.children(".imported").length;var a=this.$list.children(".processing").length,b=this.$list.children().length,d=this.$queue.children(":not(.canceled)").length,c=this.$queue.children(".waiting").length;this.$el.find(".ga-importer-start").toggle(b==0&&d==0);this.$el.find(".ga-importer-results").toggle(b>0);this.$el.find(".ga-importer-queue-message").toggle(c>0);if(this.importedCount==0){$(".ga-importer-notice-count").hide();if(this.studio&&d==0&&a==0){this.studio.importerStatus("clear")}}else{if(this.importedCount==1){$(".ga-importer-notice-count").text(GT.strargs("%1 file has been added to Your Library.",[1]))}else{$(".ga-importer-notice-count").text(GT.strargs("%1 files have been added to Your Library.",[this.importedCount]))}$(".ga-importer-notice-count").show();if(this.studio&&(d==c)&&a==0){this.studio.importerStatus("done")}}};Importer.prototype.checkList=function(){var c=!!this.$queue.find(".uploading").length;var b=this.$queue.find(".pending");if(!c&&b.length>0){var a=b.first().data("importerFile");if(a.isValid()){this.uploadFile(a)}else{a.$el.appendTo(this.$list);this.checkList();return}}this.updateResults()};Importer.prototype.addFiles=function(a){if(a.length==0){return}this.$el.find(".ga-importer-start").hide();this.$queue.show();var b=this;$.each(a,function(c,d){var f=b.render();var e=new ImporterFile(d,f);e.setFilename(d.name);f.data("importerFile",e);b.$queue.append(f);setTimeout(function(){f.addClass("in")},100)});this.$el.find(".ga-importer-base-form").get(0).reset();this.checkList()};Importer.prototype.render=function(){var a=$("#importer-file-tmpl").tmpl();return $(a)};Importer.prototype.uploadFile=function(c){var a=this;if(this.studio){this.studio.importerStatus("processing")}c.status("uploading");var b=new FormData();b.append("file",c.file);b.append("subtype",c.subtype);c.xhr=$.ajax({type:"POST",url:"/ajax/saveUserProp",data:b,xhr:function(){_xhr=$.ajaxSettings.xhr();if(_xhr.upload){_xhr.upload.addEventListener("progress",$.proxy(c.onProgress,c),false)}return _xhr},success:function(d){a.fileUploaded(c,d)},processData:false,contentType:false,dataType:"json"}).always(function(){a.checkList()})};Importer.prototype.fileUploaded=function(b,a){if(a.suc){b.asset.id=a.id;b.asset.type=a.asset_type;if(a.filename){b.setFilename(a.filename)}if(a.asset_data){b.asset.data=a.asset_data;if(b.asset.data.file){b.$el.data("fileId",b.asset.data.file)}}if(a.asset_type=="video"){b.status("processing");b.$el.appendTo(this.$list);b.setIcon("loading");if(this.studio){b.studio=this.studio}setTimeout(function(){b.checkVideoStatus()},30000)}else{b.status("imported");b.$el.appendTo(this.$list);if(a.thumbnail){b.asset.thumbnail=a.thumbnail;b.setIcon(a.thumbnail)}else{b.setIcon(a.asset_type)}if(this.studio){b.studio=this.studio;this.studio.importerUploadComplete(b.asset.type,b.asset.id,b.asset.data)}}}else{b.status("invalid");b.setIcon("invalid");b.$el.find(".error").text(a.msg);b.$el.appendTo(this.$list)}};Importer.prototype.findImportedByFileId=function(b){var a=false;this.$list.find(".imported").each(function(){if($(this).data("fileId")==b){a=$(this)}});return a};Importer.prototype.onAssetReady=function(b,a){var c=this.findImportedByFileId(a.file);if(c){c.data("importerFile").setReady()}};Importer.prototype.onAssetDelete=function(b,a){var c=this.findImportedByFileId(a.file);if(c){c.data("importerFile").setDeleted()}};var ImporterFile=function(c,a,b){this.options=$.extend({},ImporterFile.defaults.options,b);this.file=c;this.$el=a;this._status="";this.asset={id:0,type:"",thumbnail:"",data:{}};this.studio=undefined;this.subtype="";this.initialize()};ImporterFile.prototype.initialize=function(){var b=this;var a=this.guessType();if(a=="image"){this.setIcon("image");this.setMenu("prop");this.status("waiting")}else{if(a=="flash"){this.setIcon("flash");this.setMenu("prop");this.status("waiting")}else{if(a=="audio"){this.setIcon("sound");this.setMenu("sound");this.status("waiting")}else{this.status("pending")}}}this.$el.on("click",'[data-action="add-to-scene"]',function(c){c.preventDefault();b.addToScene()}).on("click",'[data-action="cancel-upload"]',function(c){c.preventDefault();b.cancelUpload()}).on("click","[data-subtype]",function(c){c.preventDefault();b.subtype=$(this).data("subtype");b.status("pending");b.setIcon("");b.$el.find(".category").text($(this).text());b.$el.trigger("uploadReady")})};ImporterFile.prototype.status=function(a){if(a===undefined){return this._status}this.$el.removeClass(this._status);this._status=a;this.$el.addClass(this._status).trigger(this._status)};ImporterFile.prototype.setReady=function(){this.$el.addClass("ready")};ImporterFile.prototype.setDeleted=function(){this.$el.removeClass("ready").addClass("deleted");this.$el.find(".error").text(GT.gettext("This asset has been deleted"))};ImporterFile.prototype.fileTypeCheck=function(){if($.inArray(this.file.type,this.options.restricted_mime)>=0){throw"Your current plan does not support this file type"}if($.inArray(this.file.type,this.options.accept_mime)<0){throw"Invalid file type"}};ImporterFile.prototype.fileSizeCheck=function(){if(this.file.size>this.options.accept_filesize){throw"Exceeds file size limit (Max:15MB)"}};ImporterFile.prototype.guessType=function(){if(!this.file){return""}if(this.file.type=="application/x-shockwave-flash"){return"flash"}var a=this.file.type.split("/");return a[0]};ImporterFile.prototype.isValid=function(){try{this.fileTypeCheck();this.fileSizeCheck();return true}catch(a){this.status("invalid");this.setIcon("invalid");this.$el.find(".error").text(a);return false}};ImporterFile.prototype.onProgress=function(b){if(b.lengthComputable){var a=Math.floor(b.loaded/b.total*100);this.$el.find(".upload-progress").css("width",a+"%")}};ImporterFile.prototype.setFilename=function(a){this.$el.find(".filename").text(a)};ImporterFile.prototype.setIcon=function(d){var a=this.$el.find(".ga-importer-file-icon");var c=["prop","image","flash","bg","sound","video","invalid","loading"];a.removeClass(c.join(" "));if(!d){return}if($.inArray(d,c)>=0){a.addClass(d);return}var b=$("<img>").attr("src",d);a.html(b)};ImporterFile.prototype.setMenu=function(b){var a=$("#importer-select-"+b+"-tmpl").tmpl({});this.$el.find(".menu").html(a)};ImporterFile.prototype.addToScene=function(){if(this._status!="imported"){return false}if(this.studio){this.studio.importerAddAsset(this.asset.type,this.asset.data.file)}};ImporterFile.prototype.cancelUpload=function(){if(this._status=="imported"){return false}if(typeof this.xhr!=="undefined"){this.xhr.abort()}this.status("canceled");this.$el.find(".upload-progress").css("width",0);this.$el.fadeOut(400,function(){$(this).trigger("uploadCanceled").remove()})};ImporterFile.prototype.checkVideoStatus=function(){var a=this;$.post("/ajax/getAssetVideoStatus/"+this.asset.id,function(b){if(b.suc){if(b.status=="completed"){a.asset.data=b.asset_data;if(b.thumbnail){a.asset.data.thumbnail=b.thumbnail}a.$el.data("fileId",a.asset.data.file);a.status("imported");a.setIcon("video");if(a.studio){a.studio.importerUploadComplete(a.asset.type,a.asset.id,a.asset.data)}a.$el.trigger("videoReady")}else{setTimeout(function(){a.checkVideoStatus()},30000)}}else{a.status("invalid");a.setIcon("invalid");a.$el.find(".error").text(b.msg)}},"json")};ImporterFile.defaults={};ImporterFile.defaults.options={accept_mime:["image/png","image/jpeg","image/gif","image/bmp","audio/mpeg","audio/wav","audio/x-wav","audio/vnd.wave","audio/wave","audio/mp3","audio/mp4","audio/ogg","audio/vorbis","audio/aac","audio/m4a","audio/x-m4a","application/x-shockwave-flash","video/mp4","video/x-flv","video/x-ms-wmv"],restricted_mime:[],accept_filesize:15728640};var ImporterDegrade=function(a,b){this.$el=a;this.$list=this.$el.find(".ga-importer-files");this.$queue=this.$el.find(".ga-importer-queue");this.$base_form=this.$el.find(".ga-importer-base-form");this.importedCount=0;this.iframe_count=0;this.studio=b;this.initialize()};ImporterDegrade.prototype=$.extend({},Importer.prototype,{initialize:function(){var a=this;this.$el.find(".ga-importer-results, .ga-importer-start-draghere").hide();this.$el.on("videoReady",function(){a.updateResults()}).on("uploadCanceled",function(){a.$el.find(".file-trigger").prop("disabled",false);a.$el.find(".ga-importer-file-input").prop("readonly",false);a.$base_form[0].reset();a.updateResults()}).on("uploadReady",function(b){var c=$(b.target).data("importerFile");a.uploadFile(c)});this.$el.find(".file-trigger").text("Select File");this.$el.find(".ga-importer-file-input").on("change",function(){if($(this).val()){var b=a.createFile($(this).val());a.addFile(b)}}).prop("multiple",false);this.$el.find(".ga-importer-notice-clear").click(function(b){b.preventDefault();a.clearList()});this.$el.find("i.i-help").hover(function(){$(this).next(".tooltip").fadeIn()},function(){$(this).next(".tooltip").fadeOut()});if(this.studio){this.studio.bind("userAssetReady",$.proxy(this.onAssetReady,this)).bind("userAssetDelete",$.proxy(this.onAssetDelete,this))}},guessFileMIME:function(a){var b={jpeg:"image/jpeg",jpg:"image/jpeg",png:"image/png",bmp:"image/bmp",gif:"image/gif",swf:"application/x-shockwave-flash",mp3:"audio/mpeg",aiff:"audio/aiff",m4a:"audio/x-aac",wav:"audio/x-wav",zip:"application/zip",xml:"text/xml",flv:"video/x-flv",mp4:"video/mp4"};var c=a.split(".").pop();if(b[c]){return b[c]}return"unknown"},createFile:function(c){var b={};var a=c.split(/(\\|\/)/g).pop();b.name=a;b.type=this.guessFileMIME(a);return b},addFile:function(a){this.$el.find(".ga-importer-start").hide();this.$queue.show();var c=this.render();var b=new ImporterFile(a,c);c.data("importerFile",b);b.setFilename(a.name);if(b._status=="waiting"){this.$el.find(".file-trigger").prop("disabled",true);this.$el.find(".ga-importer-file-input").prop("readonly",true)}else{this.uploadFile(b)}this.$queue.append(c);setTimeout(function(){c.addClass("in")},100);this.updateResults()},uploadFile:function(d){if("undefined"==typeof this.iframe_count){this.iframe_count=0}++this.iframe_count;d.setIcon("loading");d.status("processing");var c=this,a=this.$base_form,b=$('<iframe name="if_zone_'+this.iframe_count+'" style="display:none"></iframe>');if(1==a.attr("loading")){return}a.attr("loading",1);a.attr("id","if_"+this.iframe_count);a.attr("enctype","multipart/form-data");a.attr("method","POST");a.attr("target","if_zone_"+this.iframe_count);a.find('input[name="subtype"]').val(d.subtype);$("body").append(b);a.submit();if(this.studio){this.studio.importerStatus("processing")}b.load(function(){var e=b.contents().find("body").html();e=$.parseJSON(e);b.remove();a.attr("loading",0);c.$base_form[0].reset();c.fileUploaded(d,e);c.updateResults();c.$el.find(".file-trigger").prop("disabled",false);c.$el.find(".ga-importer-file-input").prop("readonly",false)})}});